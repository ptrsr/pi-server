---
- hosts: local
  connection: local
  gather_facts: no
  vars:
    skip: false

  tasks:
  - name: Start raspi machine
    docker_container:
      name: raspi
      image: ptrsr/pi-ci
      command: start
      state: started
      tls_hostname: localhost
      published_ports:
        - 2222:2222
      volumes:
        - "{{ host.dist_dir|default(omit) }}:/dist"
    register: startup

  - name: Wait for container to warm up
    pause:
      seconds: 10
    when:
      - startup.changed == true

  - name: Wait for machine start up
    shell: curl localhost:2222
    failed_when: false
    changed_when: false
